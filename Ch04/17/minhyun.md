# 불변클래스

불변 클래스란, 해당 인스턴스의 내부 값을 수정할 수 없는 클래스이다.

(ex) String, BigInteger 등

## 규칙

1. 객체의 상태를 변경하는 메서드를 제공하지 않는다.
2. 클래스를 확장할 수 없도록 한다.
   1. class를 final로 선택하는 방법 외 뒤에 나옴.
3. 모든 필드를 final로 선언한다.
   1. 동기화없이 다른 스레드로 건네도 문제없이 동작하게끔 보장하는데도 필요
4. 모든 필드를 private로 선언한다.
5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.
   1. 방어적 복사를 수행하라.

# 함수형 프로그래밍

피연산자에 함수를 적용해 그 결과를 반환하지만, 피연산자 자체는 그대로인 프로그래밍 패턴

↔ 명령형 프로그래밍: 메서드에서 피연산자인 자신을 수정해 자신의 상태가 변하게 됨.

# 불변객체

## 특징

1. 불변 객체는 단순하다. 생성된 시점의 상태를 파괴될 때까지 그대로 간직한다.
2. 스레드에 안전하여 따로 동기화 할 필요가 없다. → 안심하고 공유할 수 있다.
   - 한번 만든 인스턴스를 최대한 재활용하기를 권한다.
3. 자주 사용되는 인스턴스를 캐싱하여 팩터리를 제공할 수 있다.
4. 방어적 복사가 필요없다.
   - clone 메서드나 복사 생성자를 제공하지 않는게 좋다.
5. 불변 객체 끼리는 내부 데이터를 공유할 수 있다.
6. 객체를 만들 때 다른 불변 객체들을 구성 요소로 사용하면 이점이 많다.
   1. 구조가 아무리 복잡하더라도 불변식을 유지하기 훨씬 수월하기 때문
7. 실패 원자성을 제공한다.
   1. 실패 원자성이란, 메서드에서 예외가 발생한 후에도 그 객체는 여전히 유효한 상태여야 한다는 성질이다.
8. 값이 다르면 반드시 독립된 객체로 만들어야 한다.

## 단점

결국 8번의 특징이 단점이다. 새로운 객체를 만들긴 하지만, 해당 객체들이 중간단계에서 모두 버려진다면 성능 문제가 생긴다.

### 해결법

1. 다단계 연산들을 예측하여 기본 기능으로 제공
   - (ex) String → StringBuilder, StringBuffer

# 불변 클래스를 만드는 설계 방법

- 자신을 상속하지 못하게 하는 방법
  - 모든 생성자를 private로 만들고 public 정적 팩토리를 제공하는 방법

`BigInteger` 와 `BigDecimal` 내의 메서드들은 모두 재정의 할 수 있게 설계 되었고, 하위호환성떄문에 현재까지 문제를 고치지 못했다. 즉 안전하게 방어적으로 복사하여 사용하자(아이템 50)

![image-20220813231806108](https://tva1.sinaimg.cn/large/e6c9d24egy1h55i1bv3wkj20ga061gm2.jpg)

# 정리

- getter가 있다고 해서 무조건 setter를 만들진 말자.
- 클래스는 꼭 필요한 경우가 아니면 불변이어야 한다.
- 불변으로 만들 수 없는 클래스라도 변경할 수 있는 부분을 최소한으로 줄이자.
- 대부분 모든 필드는 private final 이어야 한다.
- 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다.
- 생성자와 정적 팩터리 외에는 어떠한 초기화 메서드도 public으로 제공해선 안된다.
